<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الرئيسية - الدكتور</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media (max-width: 992px) {
            .grid-container.grid-3 {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .hero {
                height: auto;
                min-height: 100vh;
                padding: 120px 20px 60px;
            }
            .hero h1 {
                font-size: 2.5rem !important;
                line-height: 1.3;
            }
            .hero-desc {
                width: 100%;
                font-size: 1rem;
                margin: 0 auto 30px;
            }
            .hero-btns {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }
            .grid-container.grid-3 {
                gap: 25px;
                padding-top: 30px !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fa-solid fa-heart-pulse"></i>
            <div class="logo-text"><span>الدكتور</span><small>BIOLOGY MASTER</small></div>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="active">الرئيسية</a></li>
            <li><a href="library.html">الكتب</a></li>
            <li><a href="videos.html">الفيديوهات</a></li>
            <li><a href="schedule.html">الجدول</a></li>
            <li><a href="reviews.html">ورق الشرح</a></li>
            <li><a href="contact.html">تواصل معنا</a></li>
        </ul>
        <a href="scientific-books.html" class="btn-nav-special">الكتب العلمية النادرة</a>
        <div class="menu-btn"><i class="fa-solid fa-bars"></i></div>
    </nav>

    <section class="hero">
        <div class="hero-content">
            <div class="hero-text">
                <p class="subtitle scroll-animate" style="transition-delay: 0.1s;">BIOLOGY LAB</p>
                <h1 class="scroll-animate" style="transition-delay: 0.2s;">عالم الأحياء <br> <span class="neon-green-text">بمنظور مختلف</span></h1>
                <p class="hero-desc scroll-animate" style="transition-delay: 0.3s;">استعد لرحلة فريدة في أعماق الخلية والتشريح مع دكتور عبدالله . تعليمنا ليس مجرد حفظ، بل هو تجربة بصرية وعلمية تفوق الخيال.</p>
                <div class="hero-btns scroll-animate" style="transition-delay: 0.4s;">
                    <a href="videos.html" class="btn-green">ابدأ المشاهدة الآن</a>
                    <a href="library.html" class="btn-outline">تصفح المكتبة</a>
                </div>
            </div>
            
            <div class="hero-image scroll-animate" style="transition-delay: 0.5s;">
                <img src="212.png" alt="دكتور عبدالله" class="doctor-img">
            </div>
        </div>
    </section>

    <section class="container">
        <div class="grid-container grid-3" style="padding-top: 50px;">
            <div class="feature-box scroll-animate" style="transition-delay: 0.1s;">
                <i class="fa-solid fa-book-open" style="color:var(--neon-red)"></i>
                <h3>محتوى حصري</h3>
                <p style="color:#888; font-size:0.9rem">كتب ومذكرات أعدها الدكتور خصيصاً لتسهيل أصعب المفاهيم.</p>
            </div>
            <div class="feature-box green scroll-animate" style="transition-delay: 0.2s;">
                <i class="fa-regular fa-circle-play"></i>
                <h3>فيديوهات 4K</h3>
                <p style="color:#888; font-size:0.9rem">شروحات تفصيلية بجودة عالية تركز على الفهم العميق للبيولوجيا.</p>
            </div>
            <div class="feature-box scroll-animate" style="transition-delay: 0.3s;">
                <i class="fa-solid fa-shield-halved" style="color:var(--neon-red)"></i>
                <h3>تقييم مستمر</h3>
                <p style="color:#888; font-size:0.9rem">اختبارات دورية ومتابعة دقيقة لكل طالب لضمان التفوق.</p>
            </div>
        </div>
    </section>

    <footer>
        <p style="text-align: center;">جميع الحقوق محفوظة © 2026 | تم التطوير بواسطة فريق عبقرينو & كيمو <i class="fa-solid fa-heart"></i></p>
    </footer>

    <script>
        const menuBtn = document.querySelector('.menu-btn');
        const navLinks = document.querySelector('.nav-links');
        menuBtn.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            menuBtn.innerHTML = navLinks.classList.contains('active') ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-bars"></i>';
        });

        // Scroll Animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, {
            threshold: 0.1
        });

        const animatedElements = document.querySelectorAll('.scroll-animate');
        animatedElements.forEach((el) => observer.observe(el));
    </script>

    <!-- زر الأخبار العائم -->
    <div class="news-float-btn" onclick="openNewsModal()">
        <div class="news-badge" id="newsBadge"></div>
        <i class="fa-solid fa-bell"></i>
        <span>الأخبار</span>
    </div>

    <!-- نظام الإشعارات الناري (للمستخدم المتصل) -->
    <div id="fire-notification" class="fire-toast">
        <i class="fa-solid fa-fire-flame-curved"></i>
        <img id="fire-msg-img" src="" alt="مرفق">
        <div>
            <h4>تنبيه عاجل من الدكتور</h4>
            <small id="fire-msg-text">رسالة جديدة...</small>
        </div>
    </div>

    <!-- نافذة الأخبار المنبثقة -->
    <div class="news-modal-overlay" id="newsOverlay">
        <div class="news-modal">
            <div class="news-header">
                <h3><i class="fa-solid fa-bullhorn"></i> آخر تعليمات الدكتور</h3>
                <i class="fa-solid fa-xmark close-news" onclick="closeNewsModal()"></i>
            </div>
            <div class="news-list" id="newsList">
                <p style="text-align:center; color:#666; padding:20px;">جاري تحميل الأخبار...</p>
            </div>
            <button onclick="markAsRead()" class="btn-mark-read"><i class="fa-solid fa-check"></i> تم القراءة بنجاح</button>
            <button onclick="location.href='contact.html'" style="margin-top:15px; width:100%; padding:10px; background:var(--neon-green); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">الذهاب لغرفة الشات الكاملة</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, query, limitToLast, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyD092yeOowtCLW0fDcIzaEXrnxvrN4X5T8", authDomain: "abqarieno.firebaseapp.com", databaseURL: "https://abqarieno-default-rtdb.firebaseio.com", projectId: "abqarieno", storageBucket: "abqarieno.firebasestorage.app", messagingSenderId: "790682500839", appId: "1:790682500839:web:cd50b8e01729f821e06c42" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const newsListEl = document.getElementById('newsList');
        const badgeEl = document.getElementById('newsBadge');
        const floatBtn = document.querySelector('.news-float-btn');
        const fireToast = document.getElementById('fire-notification');
        const fireText = document.getElementById('fire-msg-text');
        const fireImg = document.getElementById('fire-msg-img');
        
        const lastSeenTime = localStorage.getItem('biology_last_seen_news') || 0;
        const loadTime = Date.now(); // وقت فتح الموقع
        let latestMsgTime = 0;

        // 1. مراقب الرسائل الفورية (للمستخدم المتصل حالياً)
        onChildAdded(query(ref(db, 'broadcasts'), limitToLast(1)), (snapshot) => {
            const msg = snapshot.val();
            // إذا كانت الرسالة وصلت بعد فتح الموقع (رسالة جديدة واليوزر فاتح)
            if (msg.timestamp > loadTime) {
                fireText.textContent = msg.text; // عرض نص الرسالة
                
                // عرض الصورة المصغرة إذا وجدت
                if (msg.media && msg.media.includes('data:image')) {
                    fireImg.src = msg.media;
                    fireImg.classList.add('show');
                } else {
                    fireImg.classList.remove('show');
                }

                fireToast.classList.add('show');
                
                // تشغيل صوت تنبيه خفيف (اختياري)
                // const audio = new Audio('notification.mp3'); audio.play().catch(()=>{});

                setTimeout(() => {
                    fireToast.classList.remove('show');
                }, 8000); // يختفي بعد 8 ثواني
            }
        });

        // عند الضغط على الإشعار: تسجيل الدخول كطالب والذهاب للشات
        fireToast.onclick = () => {
            localStorage.setItem('biology_user_role', 'student');
            window.location.href = 'contact.html';
        };

        // 2. مراقب قائمة الأخبار (للمستخدم الغائب أو السجل)
        const q = query(ref(db, 'broadcasts'), limitToLast(4));
        
        onValue(q, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                newsListEl.innerHTML = '<p style="text-align:center; color:#666;">لا توجد أخبار حالياً</p>';
                return;
            }

            // تحويل البيانات لمصفوفة وترتيبها من الأحدث للأقدم
            const msgs = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
            
            // تحديث القائمة
            newsListEl.innerHTML = '';
            let hasNew = false;
            let currentBatchMaxTime = 0;

            msgs.forEach(msg => {
                // تصفية الرسائل: عرض فقط الرسائل التي كانت موجودة قبل فتح الموقع
                // الرسائل الجديدة تظهر فقط في التنبيه الناري (Fire Toast)
                if (msg.timestamp > loadTime) return;

                const isNew = msg.timestamp > lastSeenTime;
                if (isNew) hasNew = true;
                if (msg.timestamp > currentBatchMaxTime) currentBatchMaxTime = msg.timestamp;

                const dateStr = new Date(msg.timestamp).toLocaleDateString('ar-EG') + ' ' + new Date(msg.timestamp).toLocaleTimeString('ar-EG');
                const mediaHtml = msg.media ? `<a href="${msg.media}" target="_blank" class="news-link"><i class="fa-solid fa-paperclip"></i> مرفق</a>` : '';

                const html = `
                    <div class="news-item ${isNew ? 'new' : ''}">
                        <span class="news-date">${dateStr} ${isNew ? '<span style="color:red; font-weight:bold">(جديد)</span>' : ''}</span>
                        <div class="news-text">${msg.text}</div>
                        ${mediaHtml}
                    </div>
                `;
                newsListEl.insertAdjacentHTML('beforeend', html);
            });
            
            latestMsgTime = currentBatchMaxTime;

            // المنطق الجديد: إظهار الزر فقط إذا كان هناك أخبار جديدة
            if (hasNew) {
                floatBtn.style.display = 'flex';
                badgeEl.classList.add('active');
                floatBtn.classList.add('glowing'); // تشغيل الإضاءة
            } else {
                floatBtn.style.display = 'none';
            }
        });

        // دوال التحكم في النافذة (Global Scope)
        window.openNewsModal = function() {
            document.getElementById('newsOverlay').classList.add('open');
        };

        window.markAsRead = function() {
            if (latestMsgTime > 0) {
                localStorage.setItem('biology_last_seen_news', latestMsgTime);
            }
            badgeEl.classList.remove('active');
            floatBtn.classList.remove('glowing'); // إيقاف الإضاءة
            floatBtn.style.display = 'none'; // إخفاء الزر الرئيسي
            newsListEl.innerHTML = ''; // تفريغ القائمة (حذف الرسائل بصرياً)
            window.closeNewsModal();
        };

        window.closeNewsModal = function() {
            document.getElementById('newsOverlay').classList.remove('open');
        };

        // إغلاق النافذة عند الضغط خارجها
        document.getElementById('newsOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('newsOverlay')) {
                window.closeNewsModal();
            }
        });
    </script>
</body>
</html>